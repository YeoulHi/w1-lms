# Gemini CLI Prompt for Log Documentation

다음 내용을 바탕으로 `docs/003/log-001.md` 파일을 작성해주세요.

## 작업 개요
강의 생성 기능(spec-003)을 구현하면서 발생한 주요 이슈와 해결 과정을 상세히 문서화합니다.

## 포함해야 할 내용

### 1. 구현 완료 항목
#### Backend
- `src/features/courses/backend/schema.ts` - CreateCourseRequest, CreateCourseResponse 스키마 정의
- `src/features/courses/backend/error.ts` - coursesErrorCodes 정의 (courseCreationError, validationError, unauthorized)
- `src/features/courses/backend/service.ts` - createCourseService 비즈니스 로직 (instructor_id 자동 설정, status: 'draft' 기본값)
- `src/features/courses/backend/route.ts` - POST /api/courses 엔드포인트 (Authorization 헤더 기반 인증)
- `src/backend/hono/app.ts` - registerCoursesRoutes 등록

#### Frontend
- `src/features/courses/lib/dto.ts` - 타입 재사용
- `src/features/courses/hooks/useCreateCourse.ts` - React Query useMutation 훅
- `src/features/courses/components/CreateCourseForm.tsx` - 폼 컴포넌트
- `src/app/instructor/courses/create/page.tsx` - 강의 생성 페이지 라우트

### 2. 주요 이슈와 해결 과정

#### 이슈 1: middleware.ts 타입 에러
**문제**:
```
No overload matches this call.
'getAll' does not exist in type 'CookieMethodsServerDeprecated'
```

**원인**: Supabase SSR의 쿠키 메서드가 `set`, `remove` 개별 함수에서 `setAll` 일괄 처리 방식으로 변경됨

**해결**:
```typescript
// Before
cookies: {
  set(name, value, options) { ... },
  remove(name, options) { ... }
}

// After
cookies: {
  getAll() { return request.cookies.getAll(); },
  setAll(cookiesToSet) {
    cookiesToSet.forEach(({ name, value, options }) => {
      request.cookies.set({ name, value, ...options });
    });
  }
}
```

**수정 파일**:
- `middleware.ts`
- `src/lib/supabase/server-client.ts` (읽기 전용으로 변경)

#### 이슈 2: Server Component 쿠키 수정 불가
**문제**:
```
Error: Cookies can only be modified in a Server Action or Route Handler
```

**원인**: `server-client.ts`의 `setAll`이 Server Component에서 호출됨

**해결**: Server Component용 클라이언트는 읽기 전용으로 변경 (setAll 제거)

#### 이슈 3: 401 Unauthorized - 인증 토큰 전달 실패
**문제**:
- Frontend에서 API 호출 시 쿠키 전송 (`withCredentials: true`) 설정했으나 401 에러 발생
- Backend에서 `service-role key`를 사용하는 Supabase 클라이언트가 사용자 쿠키를 읽을 수 없음

**원인**:
- Hono API는 Next.js와 별도 프로세스가 아니지만, service-role 클라이언트는 관리자 전용으로 사용자 세션을 인식하지 못함
- 쿠키는 브라우저에 존재하지만, Backend의 `supabase.auth.getUser()`가 이를 읽을 방법이 없음

**해결 방법**:

##### 3-1. Backend 수정
1. **Supabase Anon Client 생성 함수 추가** (`src/backend/supabase/client.ts`)
```typescript
export const createAnonClient = ({
  url,
  anonKey,
  accessToken,
}: AnonClientConfig): SupabaseClient => {
  const client = createClient(url, anonKey, {
    auth: { persistSession: false },
  });

  if (accessToken) {
    client.auth.setSession({
      access_token: accessToken,
      refresh_token: '',
    });
  }

  return client;
};
```

2. **AppConfig에 anonKey 추가** (`src/backend/hono/context.ts`, `src/backend/config/index.ts`)
```typescript
export type AppConfig = {
  supabase: {
    url: string;
    serviceRoleKey: string;
    anonKey: string; // ← 추가
  };
};
```

3. **Authorization 헤더에서 토큰 추출** (`src/features/courses/backend/route.ts`)
```typescript
// Extract access token from Authorization header
const authHeader = c.req.header('Authorization');
const accessToken = authHeader?.replace('Bearer ', '');

if (!accessToken) {
  return respond(c, failure(401, coursesErrorCodes.unauthorized, '인증 토큰이 필요합니다.'));
}

// Create anon client with user's access token
const supabase = createAnonClient({
  url: config.supabase.url,
  anonKey: config.supabase.anonKey,
  accessToken,
});

const { data: { user }, error: authError } = await supabase.auth.getUser();
```

##### 3-2. Frontend 수정
**Axios 인터셉터로 Authorization 헤더 자동 추가** (`src/lib/remote/api-client.ts`)
```typescript
import { createClient } from "@/lib/supabase/client";

apiClient.interceptors.request.use(async (config) => {
  const supabase = createClient();
  const { data: { session } } = await supabase.auth.getSession();

  if (session?.access_token) {
    config.headers.Authorization = `Bearer ${session.access_token}`;
  }

  return config;
});
```

**장점**:
- 모든 API 요청에 자동으로 인증 토큰 포함
- 각 훅에서 개별적으로 토큰을 처리할 필요 없음
- Supabase 세션 갱신 시 자동으로 최신 토큰 사용

### 3. 검증 결과
- ✅ ESLint: 경고/에러 없음
- ✅ TypeScript: 타입 에러 없음
- ✅ Build: 성공적으로 완료
- ✅ API 테스트: POST /api/courses → 201 Created

### 4. 파일 변경 요약
```
Modified:
- middleware.ts (쿠키 처리 방식 변경)
- src/lib/supabase/server-client.ts (읽기 전용)
- src/backend/supabase/client.ts (createAnonClient 추가)
- src/backend/hono/context.ts (anonKey 추가)
- src/backend/config/index.ts (NEXT_PUBLIC_SUPABASE_ANON_KEY 읽기)
- src/lib/remote/api-client.ts (Authorization 헤더 인터셉터)
- src/backend/hono/app.ts (registerCoursesRoutes 등록)

Created:
- src/features/courses/backend/schema.ts
- src/features/courses/backend/error.ts
- src/features/courses/backend/service.ts
- src/features/courses/backend/route.ts
- src/features/courses/lib/dto.ts
- src/features/courses/hooks/useCreateCourse.ts
- src/features/courses/components/CreateCourseForm.tsx
- src/app/instructor/courses/create/page.tsx
```

### 5. 중요한 학습 포인트
1. **Supabase SSR 쿠키 처리**: `set`/`remove` → `setAll` 패턴 변경
2. **Service vs Anon Client**:
   - Service-role: 관리자 작업 (사용자 생성, RLS 우회)
   - Anon: 사용자 인증 작업 (토큰 기반 세션 관리)
3. **Authorization 헤더 패턴**: 쿠키보다 명시적이고 API 간 호환성이 좋음
4. **Axios 인터셉터**: 공통 로직(인증, 로깅 등)을 중앙 집중화

---

위 내용을 바탕으로 markdown 형식의 로그 문서를 작성해주세요.
각 섹션은 명확한 제목과 코드 블록을 포함하고, 이슈 해결 과정은 "문제 → 원인 → 해결" 구조로 작성해주세요.
